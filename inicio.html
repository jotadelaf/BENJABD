<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Empleados</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <h1>Sistema de Empleados</h1>
        
        <!-- Navegación -->
        <nav class="nav-tabs">
            <button class="nav-btn active" onclick="showForm('registrar')">Registrar</button>
            <button class="nav-btn" onclick="showForm('modificar')">Modificar</button>
            <button class="nav-btn" onclick="showForm('eliminar')">Eliminar</button>
            <button class="nav-btn" onclick="showForm('listar1')">Listar 1</button>
            <button class="nav-btn" onclick="showForm('listar2')">Listar 2</button>
            <button class="nav-btn" onclick="window.location.href='ver_respaldos.php'">Respaldos</button>
        </nav>

        <!-- Formulario Registrar Empleado -->
        <div id="registrar" class="form-section active">
            <h2>Registrar Empleado</h2>
            <form action="insertar.php" method="post">
                <div class="form-group">
                    <label for="nombre">Nombre:</label>
                    <input type="text" id="nombre" name="nombre" required>
                </div>

                <div class="form-group">
                    <label for="apellido">Apellido:</label>
                    <input type="text" id="apellido" name="apellido" required>
                </div>

                <div class="form-group">
                    <label for="sexo">Sexo:</label>
                    <select id="sexo" name="sexo" required>
                        <option value="">Seleccione</option>
                        <option value="Masculino">Masculino</option>
                        <option value="Femenino">Femenino</option>
                        <option value="Otro">Otro</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="sueldo">Sueldo:</label>
                    <input type="number" id="sueldo" name="sueldo" step="0.01" min="0" required>
                </div>

                <button type="submit" class="btn-submit">Registrar Empleado</button>
            </form>
        </div>

        <!-- Formulario Modificar Empleado -->
        <div id="modificar" class="form-section">
            <h2>Modificar Sueldo de Empleado</h2>
            <form action="actualizar.php" method="post" id="formModificarSueldo">
                <div class="form-group">
                    <label for="buscar_empleado">Buscar Empleado:</label>
                    <div class="search-container">
                        <input type="text" id="buscar_empleado" name="buscar_empleado" placeholder="Escriba el nombre del empleado..." autocomplete="off">
                        <div id="search-results" class="search-results" style="display: none;"></div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="empleado_seleccionado">Empleado Seleccionado:</label>
                    <input type="text" id="empleado_seleccionado" name="empleado_seleccionado" readonly>
                    <input type="hidden" id="empleado_id" name="empleado_id">
                </div>

                <div class="form-group">
                    <label for="nuevo_sueldo">Nuevo Sueldo:</label>
                    <input type="number" id="nuevo_sueldo" name="nuevo_sueldo" step="0.01" min="0" required>
                </div>

                <button type="submit" class="btn-submit" id="btnActualizarSueldo">Actualizar Sueldo</button>
            </form>
        </div>

        <!-- Formulario Eliminar Empleado -->
        <div id="eliminar" class="form-section">
            <h2>Eliminar Empleado</h2>
            <form action="eliminar.php" method="post" id="formEliminarEmpleado">
                <div class="form-group">
                    <label for="buscar_empleado_eliminar">Buscar Empleado:</label>
                    <div class="search-container">
                        <input type="text" id="buscar_empleado_eliminar" name="buscar_empleado_eliminar" placeholder="Escriba el nombre del empleado..." autocomplete="off">
                        <div id="search-results-eliminar" class="search-results" style="display: none;"></div>
                    </div>
                </div>

                <div class="form-group">
                    <label>Resultados de Búsqueda:</label>
                    <div id="empleados-lista" class="empleados-lista" style="display: none;">
                        <!-- Los empleados se mostrarán aquí dinámicamente -->
                    </div>
                </div>
            </form>
        </div>

        <!-- Formulario Listar Empleados 1 -->
        <div id="listar1" class="form-section">
            <h2>Listar Todos los Empleados</h2>
            <button type="button" class="btn-submit" onclick="cargarTodosLosEmpleados()">Mostrar Empleados</button>
            <div id="lista-empleados-todos" class="empleados-lista">
                <!-- Los empleados se cargarán aquí -->
            </div>
        </div>

        <!-- Formulario Listar Empleados 2 -->
        <div id="listar2" class="form-section">
            <h2>Listar Empleados por Sexo</h2>
            <div class="form-group">
                <label for="filtro_sexo">Filtrar por Sexo:</label>
                <select id="filtro_sexo" name="filtro_sexo">
                    <option value="">Todos</option>
                    <option value="Masculino">Masculino</option>
                    <option value="Femenino">Femenino</option>
                    <option value="Otro">Otro</option>
                </select>
            </div>
            <div id="lista-empleados-filtrados" class="empleados-lista">
                <!-- Los empleados filtrados se mostrarán aquí -->
            </div>
        </div>
    </div>

    <script>
        function showForm(formId) {
            // Ocultar todos los formularios
            const forms = document.querySelectorAll('.form-section');
            forms.forEach(form => form.classList.remove('active'));
            
            // Mostrar el formulario seleccionado
            const targetForm = document.getElementById(formId);
            if (targetForm) {
                targetForm.classList.add('active');
            }
            
            // Actualizar botones de navegación
            const buttons = document.querySelectorAll('.nav-btn');
            buttons.forEach(btn => btn.classList.remove('active'));
            if (event && event.target) {
                event.target.classList.add('active');
            }

            // Cargar empleados automáticamente según el formulario
            if (formId === 'listar1') {
                cargarTodosLosEmpleados();
            } else if (formId === 'listar2') {
                cargarEmpleadosFiltrados();
            }
        }

        // Funcionalidad de búsqueda en tiempo real
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('buscar_empleado');
            const searchResults = document.getElementById('search-results');
            const empleadoSeleccionado = document.getElementById('empleado_seleccionado');
            const empleadoId = document.getElementById('empleado_id');
            let searchTimeout;

            // Elementos para eliminar empleado
            const searchInputEliminar = document.getElementById('buscar_empleado_eliminar');
            const searchResultsEliminar = document.getElementById('search-results-eliminar');
            const empleadoSeleccionadoEliminar = document.getElementById('empleado_seleccionado_eliminar');
            const empleadoIdEliminar = document.getElementById('empleado_id_eliminar');
            let searchTimeoutEliminar;

            // Búsqueda para modificar sueldo
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    const query = this.value.trim();
                    
                    // Limpiar timeout anterior
                    clearTimeout(searchTimeout);
                    
                    // Ocultar resultados si no hay consulta
                    if (query.length < 2) {
                        searchResults.style.display = 'none';
                        return;
                    }

                    // Buscar después de 300ms de inactividad
                    searchTimeout = setTimeout(() => {
                        buscarEmpleados(query, searchResults, empleadoSeleccionado, empleadoId, searchInput);
                    }, 300);
                });

                // Ocultar resultados al hacer clic fuera
                document.addEventListener('click', function(e) {
                    if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
                        searchResults.style.display = 'none';
                    }
                });
            }

            // Búsqueda para eliminar empleado
            if (searchInputEliminar) {
                searchInputEliminar.addEventListener('input', function() {
                    const query = this.value.trim();
                    
                    // Limpiar timeout anterior
                    clearTimeout(searchTimeoutEliminar);
                    
                    // Ocultar resultados si no hay consulta
                    if (query.length < 2) {
                        searchResultsEliminar.style.display = 'none';
                        document.getElementById('empleados-lista').style.display = 'none';
                        return;
                    }

                    // Buscar después de 300ms de inactividad
                    searchTimeoutEliminar = setTimeout(() => {
                        buscarEmpleadosParaEliminar(query);
                    }, 300);
                });

                // Ocultar resultados al hacer clic fuera
                document.addEventListener('click', function(e) {
                    if (!searchInputEliminar.contains(e.target) && !searchResultsEliminar.contains(e.target)) {
                        searchResultsEliminar.style.display = 'none';
                    }
                });
            }

            function buscarEmpleados(query, resultsContainer, empleadoField, empleadoIdField, searchInputField) {
                // Crear formulario temporal para enviar datos
                const formData = new FormData();
                formData.append('action', 'buscar');
                formData.append('query', query);

                fetch('actualizar.php', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    mostrarResultados(data, resultsContainer, empleadoField, empleadoIdField, searchInputField);
                })
                .catch(error => {
                    console.error('Error en la búsqueda:', error);
                });
            }

            function mostrarResultados(empleados, resultsContainer, empleadoField, empleadoIdField, searchInputField) {
                resultsContainer.innerHTML = '';
                
                if (empleados.length === 0) {
                    resultsContainer.innerHTML = '<div class="search-result-item">No se encontraron empleados</div>';
                } else {
                    empleados.forEach(empleado => {
                        const item = document.createElement('div');
                        item.className = 'search-result-item';
                        item.innerHTML = `
                            <div class="employee-name">${empleado.nombre} ${empleado.apellido}</div>
                            <div class="employee-details">Sueldo actual: $${empleado.sueldo} | Sexo: ${empleado.sexo}</div>
                        `;
                        
                        item.addEventListener('click', function() {
                            empleadoField.value = `${empleado.nombre} ${empleado.apellido}`;
                            empleadoIdField.value = empleado.id;
                            searchInputField.value = `${empleado.nombre} ${empleado.apellido}`;
                            resultsContainer.style.display = 'none';
                        });
                        
                        resultsContainer.appendChild(item);
                    });
                }
                
                resultsContainer.style.display = 'block';
            }

            function buscarEmpleadosParaEliminar(query) {
                // Crear formulario temporal para enviar datos
                const formData = new FormData();
                formData.append('action', 'buscar');
                formData.append('query', query);

                fetch('actualizar.php', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    mostrarEmpleadosParaEliminar(data);
                })
                .catch(error => {
                    console.error('Error en la búsqueda:', error);
                });
            }

            function mostrarEmpleadosParaEliminar(empleados) {
                const empleadosLista = document.getElementById('empleados-lista');
                empleadosLista.innerHTML = '';
                
                if (empleados.length === 0) {
                    empleadosLista.innerHTML = '<div class="no-resultados">No se encontraron empleados</div>';
                } else {
                    empleados.forEach(empleado => {
                        const item = document.createElement('div');
                        item.className = 'empleado-item';
                        item.innerHTML = `
                            <div class="empleado-info">
                                <div class="empleado-nombre">${empleado.nombre} ${empleado.apellido}</div>
                                <div class="empleado-detalles">Sueldo: $${empleado.sueldo} | Sexo: ${empleado.sexo}</div>
                            </div>
                            <button type="button" class="btn-eliminar" data-id="${empleado.id}" data-nombre="${empleado.nombre} ${empleado.apellido}">
                                Eliminar
                            </button>
                        `;
                        
                        // Agregar evento de clic al botón eliminar
                        const btnEliminar = item.querySelector('.btn-eliminar');
                        btnEliminar.addEventListener('click', function() {
                            const empleadoId = this.getAttribute('data-id');
                            const empleadoNombre = this.getAttribute('data-nombre');
                            confirmarEliminacion(empleadoId, empleadoNombre);
                        });
                        
                        empleadosLista.appendChild(item);
                    });
                }
                
                empleadosLista.style.display = 'block';
            }

            function confirmarEliminacion(empleadoId, empleadoNombre) {
                // Primera confirmación
                const confirmacion = confirm(
                    `⚠️ ADVERTENCIA: Esta acción es IRREVERSIBLE\n\n` +
                    `¿Está completamente seguro de que desea ELIMINAR al empleado?\n\n` +
                    `Empleado: ${empleadoNombre}\n\n` +
                    `Esta acción eliminará permanentemente todos los datos del empleado.\n` +
                    `No se podrá recuperar la información una vez eliminada.\n\n` +
                    `¿Desea continuar?`
                );
                
                if (confirmacion) {
                    // Segunda confirmación con prompt
                    const confirmacionFinal = prompt(
                        `Para confirmar la eliminación, escriba exactamente "ELIMINAR":\n\n` +
                        `Empleado: ${empleadoNombre}`
                    );
                    
                    if (confirmacionFinal === 'ELIMINAR') {
                        // Si confirma ambas veces, enviar la eliminación
                        eliminarEmpleado(empleadoId, empleadoNombre);
                    } else {
                        alert('Eliminación cancelada. El empleado no ha sido eliminado.');
                    }
                }
            }

            function eliminarEmpleado(empleadoId, empleadoNombre) {
                // Crear formulario temporal para enviar datos
                const formData = new FormData();
                formData.append('empleado_id_eliminar', empleadoId);

                fetch('eliminar.php', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.text())
                .then(data => {
                    // Mostrar resultado en una nueva ventana o redirigir
                    const nuevaVentana = window.open('', '_blank');
                    nuevaVentana.document.write(data);
                    nuevaVentana.document.close();
                    
                    // Limpiar la búsqueda y actualizar la lista
                    document.getElementById('buscar_empleado_eliminar').value = '';
                    document.getElementById('empleados-lista').style.display = 'none';
                    
                    // Mostrar mensaje de éxito
                    alert(`Empleado ${empleadoNombre} eliminado exitosamente.`);
                })
                .catch(error => {
                    console.error('Error al eliminar:', error);
                    alert('Error al eliminar el empleado. Por favor, intente nuevamente.');
                });
            }

            // Validación de confirmación antes de modificar sueldo
            const formModificarSueldo = document.getElementById('formModificarSueldo');
            if (formModificarSueldo) {
                formModificarSueldo.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const empleado = empleadoSeleccionado.value;
                    const nuevoSueldo = document.getElementById('nuevo_sueldo').value;
                    
                    // Validar que se haya seleccionado un empleado
                    if (!empleado || empleado.trim() === '') {
                        alert('Por favor, seleccione un empleado antes de continuar.');
                        return;
                    }
                    
                    // Validar que se haya ingresado un sueldo
                    if (!nuevoSueldo || nuevoSueldo <= 0) {
                        alert('Por favor, ingrese un sueldo válido mayor a 0.');
                        return;
                    }
                    
                    // Mostrar confirmación
                    const confirmacion = confirm(
                        `¿Está seguro de que desea modificar el sueldo?\n\n` +
                        `Empleado: ${empleado}\n` +
                        `Nuevo Sueldo: $${parseFloat(nuevoSueldo).toFixed(2)}\n\n` +
                        `Esta acción no se puede deshacer.`
                    );
                    
                    if (confirmacion) {
                        // Si confirma, enviar el formulario
                        formModificarSueldo.submit();
                    }
                });
            }

            // Validación de confirmación antes de eliminar empleado
            const formEliminarEmpleado = document.getElementById('formEliminarEmpleado');
            if (formEliminarEmpleado) {
                formEliminarEmpleado.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const empleado = empleadoSeleccionadoEliminar.value;
                    
                    // Validar que se haya seleccionado un empleado
                    if (!empleado || empleado.trim() === '') {
                        alert('Por favor, seleccione un empleado antes de continuar.');
                        return;
                    }
                    
                    // Mostrar confirmación de eliminación
                    const confirmacion = confirm(
                        `⚠️ ADVERTENCIA: Esta acción es IRREVERSIBLE\n\n` +
                        `¿Está completamente seguro de que desea ELIMINAR al empleado?\n\n` +
                        `Empleado: ${empleado}\n\n` +
                        `Esta acción eliminará permanentemente todos los datos del empleado.\n` +
                        `No se podrá recuperar la información una vez eliminada.\n\n` +
                        `Escriba "ELIMINAR" para confirmar:`
                    );
                    
                    if (confirmacion) {
                        // Segunda confirmación con prompt
                        const confirmacionFinal = prompt(
                            `Para confirmar la eliminación, escriba exactamente "ELIMINAR":\n\n` +
                            `Empleado: ${empleado}`
                        );
                        
                        if (confirmacionFinal === 'ELIMINAR') {
                            // Si confirma ambas veces, enviar el formulario
                            formEliminarEmpleado.submit();
                        } else {
                            alert('Eliminación cancelada. El empleado no ha sido eliminado.');
                        }
                    }
                });
            }

            // Funciones para cargar empleados
            function cargarTodosLosEmpleados() {
                const listaContainer = document.getElementById('lista-empleados-todos');
                if (!listaContainer) {
                    return;
                }

                // Mostrar indicador de carga
                listaContainer.innerHTML = '<div class="no-resultados">Cargando empleados...</div>';

                // Usar fetch para la petición AJAX
                const formData = new FormData();
                formData.append('action', 'listar_todos');

                fetch('listar1.php', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.text())
                .then(data => {
                    listaContainer.innerHTML = data;
                })
                .catch(error => {
                    console.error('Error al cargar empleados:', error);
                    listaContainer.innerHTML = '<div class="no-resultados">Error al cargar los empleados</div>';
                });
            }

            function cargarEmpleadosFiltrados() {
                const filtroSexo = document.getElementById('filtro_sexo').value;
                const listaContainer = document.getElementById('lista-empleados-filtrados');
                if (!listaContainer) {
                    return;
                }

                // Mostrar indicador de carga
                listaContainer.innerHTML = '<div class="no-resultados">Cargando empleados...</div>';

                // Usar fetch para la petición AJAX
                const formData = new FormData();
                formData.append('action', 'listar_filtrados');
                formData.append('filtro_sexo', filtroSexo);

                fetch('listar2.php', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.text())
                .then(data => {
                    listaContainer.innerHTML = data;
                })
                .catch(error => {
                    console.error('Error al cargar empleados filtrados:', error);
                    listaContainer.innerHTML = '<div class="no-resultados">Error al cargar los empleados</div>';
                });
            }

            // Evento para el filtro por sexo
            const filtroSexo = document.getElementById('filtro_sexo');
            if (filtroSexo) {
                filtroSexo.addEventListener('change', function() {
                    cargarEmpleadosFiltrados();
                });
            }
        });
    </script>
</body>
</html>